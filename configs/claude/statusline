#!/usr/bin/env bash
#
# statusline - Claude Code status line with context bar + git branch
#
# Reads JSON from stdin (Claude Code status line protocol) and outputs:
#   󰧑 ▰▰▰▰▰▱▱▱▱▱▱▱▱▱▱▱▱▱▱▱  main  󰒡 a1b2c3d4
#
# Context bar is color-coded:
#   Green:  0-39%
#   Yellow: 40-59%
#   Red:    60%+
#
set -o errexit -o nounset -o pipefail

# Thresholds
YELLOW=40
RED=60
COMPACT=80

BAR_WIDTH=20

payload="$(cat || true)"

# Parse JSON
if ! command -v jq >/dev/null 2>&1 || [ -z "$payload" ]; then
  echo "no data"
  exit 0
fi

read -r percent dir session_id < <(
  printf '%s' "$payload" | jq -r '[
    (.context_window.used_percentage // 0 | floor),
    (.workspace.current_dir // .workspace.project_dir // .cwd // ""),
    (.session_id // "")
  ] | @tsv'
)

percent="${percent%%.*}" # truncate any decimal
: "${percent:=0}"

# Git branch
branch=""
if [ -n "$dir" ] && [ -d "$dir" ]; then
  branch="$(cd "$dir" && git branch --show-current 2>/dev/null || true)"
fi

# Short session ID (first 8 chars)
short_id=""
if [ -n "$session_id" ]; then
  short_id="${session_id:0:8}"
fi

# Color based on thresholds
if [ "$percent" -ge "$RED" ]; then
  color="\033[31m"
elif [ "$percent" -ge "$YELLOW" ]; then
  color="\033[33m"
else
  color="\033[32m"
fi
reset="\033[0m"

# Build bar
filled=$((percent * BAR_WIDTH / 100))
[ "$filled" -gt "$BAR_WIDTH" ] && filled=$BAR_WIDTH
empty=$((BAR_WIDTH - filled))

bar=""
[ "$filled" -gt 0 ] && bar="$(printf '%0.s▰' $(seq 1 "$filled"))"
[ "$empty" -gt 0 ] && bar="${bar}$(printf '%0.s▱' $(seq 1 "$empty"))"

# Output: context bar, then git branch, then session ID
right=""
if [ -n "$branch" ]; then
  right="   $branch"
fi
if [ -n "$short_id" ]; then
  right="${right}  \033[2m󰒡 ${short_id}\033[0m"
fi
printf ' 󰧑 %b%s%b' "$color" "$bar" "$reset"
printf '%b\n' "$right"

# OSC 9;4 terminal progress bar
if [ "$percent" -gt 0 ]; then
  if [ "$percent" -ge "$COMPACT" ]; then
    progress=100
  else
    progress=$((percent * 100 / COMPACT))
  fi

  if [ "$percent" -ge "$RED" ]; then
    state=2
  elif [ "$percent" -ge "$YELLOW" ]; then
    state=4
  else
    state=1
  fi
  printf '\033]9;4;%d;%d\a' "$state" "$progress" >/dev/tty 2>/dev/null || true
fi
